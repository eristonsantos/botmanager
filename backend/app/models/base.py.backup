# backend/app/models/base.py
"""
Módulo base com classes abstratas e mixins para todos os modelos.

Define:
- BaseModel: Classe base com campos comuns (id, tenant_id, timestamps)
- SoftDeleteMixin: Mixin para soft delete automático
"""

from datetime import datetime
from typing import Optional
from uuid import UUID, uuid4

from sqlmodel import Field, SQLModel, Column, DateTime
from sqlalchemy import func


class SoftDeleteMixin:
    """
    Mixin para implementar soft delete automático.
    
    Adiciona APENAS MÉTODOS para soft delete.
    O campo deleted_at é definido em BaseModel.
    """
    
    def soft_delete(self) -> None:
        """Marca o registro como deletado (soft delete)."""
        self.deleted_at = datetime.utcnow()
    
    def restore(self) -> None:
        """Restaura um registro deletado."""
        self.deleted_at = None
    
    @property
    def is_deleted(self) -> bool:
        """Verifica se o registro está deletado."""
        return self.deleted_at is not None


class BaseModel(SQLModel, SoftDeleteMixin):
    """
    Classe base abstrata para todos os modelos do sistema.
    
    Fornece campos comuns:
    - id: UUID primary key
    - tenant_id: UUID para multi-tenancy
    - created_at: Timestamp de criação
    - updated_at: Timestamp de última atualização
    - deleted_at: Soft delete (via SoftDeleteMixin)
    
    Configurações:
    - table=False: Esta é uma classe base, não uma tabela
    - Cada subclasse com table=True cria sua própria tabela
    - Indexes automáticos em tenant_id e deleted_at
    """
    
    __abstract__ = True  # Marcar como abstrata para SQLModel
    
    # Primary Key
    id: UUID = Field(
        default_factory=uuid4,
        primary_key=True,
        index=True,
        description="Identificador único do registro"
    )
    
    # Multi-tenancy obrigatório
    tenant_id: UUID = Field(
        foreign_key="tenant.id",
        index=True,
        nullable=False,
        description="ID do tenant (organização) proprietário do registro"
    )
    
    # Timestamps automáticos (sem sa_column na classe base)
    created_at: datetime = Field(
        default_factory=datetime.utcnow,
        description="Data de criação do registro"
    )
    
    updated_at: datetime = Field(
        default_factory=datetime.utcnow,
        description="Data da última atualização do registro"
    )
    
    # Soft delete (sem sa_column na classe base)
    deleted_at: Optional[datetime] = Field(
        default=None,
        description="Data de exclusão lógica (soft delete)"
    )
    
    class Config:
        """Configurações Pydantic."""
        json_encoders = {
            datetime: lambda v: v.isoformat(),
            UUID: lambda v: str(v)
        }
        # Permite uso de ORM mode
        from_attributes = True